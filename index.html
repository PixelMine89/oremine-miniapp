<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>OreMine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
  --bg: #0b0e13;
  --panel: #141824;
  --panel-soft: #1b2032;
  --accent: #f5c77a;
  --muted: #9aa0b4;
  --danger: #ff6b6b;
  --success: #4cd964;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg);
  color: white;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  padding-bottom: 90px;
}

/* ===== HEADER ===== */
.header {
  text-align: center;
  padding: 16px;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* ===== COMMON ===== */
.box {
  background: linear-gradient(180deg, var(--panel), var(--panel-soft));
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.label {
  font-size: 12px;
  color: var(--muted);
}

button {
  background: linear-gradient(180deg, #f5c77a, #d6a956);
  border: none;
  border-radius: 14px;
  padding: 12px;
  font-weight: 700;
  cursor: pointer;
}

button:disabled {
  opacity: 0.4;
}

/* ===== TABS ===== */
.tab {
  display: none;
  padding: 16px;
}

/* ===== MINE ===== */
.mine-shaft {
  height: 240px;
  background: linear-gradient(180deg, #0c1020, #070a14);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

.block {
  width: 140px;
  height: 140px;
  border-radius: 16px;
  background: #444;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.hp-bar {
  width: 100%;
  height: 8px;
  background: #222;
  border-radius: 4px;
  margin-top: 8px;
  overflow: hidden;
}

.hp-fill {
  height: 100%;
  background: var(--success);
}

/* ===== FURNACE ===== */

.furnace-core {
  height: 140px;
  border-radius: 16px;
  background: radial-gradient(circle, #ffae42, #5a2a00);
  margin-bottom: 12px;
}

/* ===== EQUIP ===== */
.item {
  background: #1a1f33;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 8px;
}

/* ===== BOTTOM NAV ===== */
.nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #0c0f1a;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  border-top: 1px solid #222;
}

.nav-btn {
  padding: 10px 0;
  text-align: center;
  font-size: 12px;
  color: var(--muted);
}

.nav-btn.active {
  color: var(--accent);
}

.nav-btn div {
  font-size: 20px;
}
  </style>
</head>
<body>
<!--
<h2>‚õèÔ∏è OreMine</h2>

<div class="box">
  <button onclick="showTab('mine')">‚õèÔ∏è –®–∞—Ö—Ç–∞</button>
  <button onclick="showTab('equip')">‚öíÔ∏è –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</button>
  <button onclick="showTab('furnace')">üî• –ü–µ—á—å</button>
</div>

<div id="status" class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="player" style="display:none">
  <div id="tab-mine" class="box">
    <div><span class="label">User ID:</span> <span id="uid"></span></div>
    <div><span class="label">–≠–Ω–µ—Ä–≥–∏—è:</span> <span id="energy"></span></div>
    <div><span class="label">–ì–ª—É–±–∏–Ω–∞:</span> <span id="depth"></span></div>

    <div class="box">
      <div class="label">–†—É–¥–∞</div>
      <div>ü™® –£–≥–æ–ª—å: <span id="ore-coal"></span></div>
      <div>üü§ –ú–µ–¥–Ω–∞—è —Ä—É–¥–∞: <span id="ore-copper"></span></div>
      <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-iron"></span></div>
      <div>üü° –ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞: <span id="ore-gold"></span></div>
      <div>üíé –ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-diamond"></span></div>
    </div>

    <div class="box">
      <div><span class="label">–ë–ª–æ–∫:</span> <span id="blockType"></span></div>
      <div>
        <span class="label">–ü—Ä–æ—á–Ω–æ—Å—Ç—å:</span>
        <span id="blockHp"></span>
      </div>
    </div>

    <button id="mineBtn">‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>

    <div id="reward" style="margin-top:8px; opacity:0.8"></div>
  </div>
  <div id="tab-equip" class="box" style="display:none">
    <h3>‚öíÔ∏è –ö—Ä–∞—Ñ—Ç –∫–∏—Ä–æ–∫</h3>

    <div id="craft-pickaxes"></div>

    <h3 style="margin-top:12px">üéí –ú–æ–∏ –∫–∏—Ä–∫–∏</h3>

    <div id="my-pickaxes"></div>
  </div>
  <div id="tab-furnace" class="box" style="display:none">
    <h3>üî• –ü–µ—á—å</h3>

    <div>–û–ø—ã—Ç –ø–ª–∞–≤–∫–∏: <span id="smeltXp">0</span></div>
    <div>–®–∞–Ω—Å —É—Å–ø–µ—Ö–∞: <span id="smeltChance">50%</span></div>

    <hr>

    <button onclick="smelt('copper')">
      üü§ –°–æ–∑–¥–∞—Ç—å –º–µ–¥–Ω—ã–π —Å–ª–∏—Ç–æ–∫ (1 –º–µ–¥–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
    </button><br><br>

    <button onclick="smelt('iron')">
      ‚öôÔ∏è –°–æ–∑–¥–∞—Ç—å –∂–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫ (1 –∂–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
    </button><br><br>

    <button onclick="smelt('gold')">
      üü° –°–æ–∑–¥–∞—Ç—å –∑–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫  (1 –∑–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
    </button><br><br>

    <button onclick="smelt('diamond')">
      üíé –°–æ–∑–¥–∞—Ç—å –∞–ª–º–∞–∑  (1 –∞–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
    </button>

    <div id="smeltResult" style="margin-top:10px; opacity:0.8"></div>

  </div>
</div>
-->

<div class="header" id="tabTitle">–®–∞—Ö—Ç–∞</div>

<div id="status" class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="player" style="display:none">

<!-- ===== MINE ===== -->
<div id="tab-mine" class="tab">
  <div class="mine-shaft">
    <div class="block" id="blockVisual">
      <div id="blockType"></div>
      <div class="hp-bar">
        <div class="hp-fill" id="hpFill"></div>
      </div>
      <div id="blockHp"></div>
    </div>
  </div>

  <div class="box">
    <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy"></span></div>
    <div>‚¨áÔ∏è –ì–ª—É–±–∏–Ω–∞: <span id="depth"></span></div>
  </div>

  <button id="mineBtn">‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>
  <div id="reward" style="margin-top:10px"></div>
</div>

<!-- ===== FURNACE ===== -->
<div id="tab-furnace" class="tab">
  <div class="box">
    <div>ü™® –£–≥–æ–ª—å<span id="ore-coal"></span></div>
    <div>üü§ –ú–µ–¥–Ω–∞—è —Ä—É–¥–∞<span id="ore-copper"></span></div>
    <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞<span id="ore-iron"></span></div>
    <div>üü° –ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞<span id="ore-gold"></span></div>
    <div>üíé –ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞<span id="ore-diamond"></span></div>
  </div>

  <div class="box">
  üü§ –ú–µ–¥–Ω—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-copper"></span>
  ‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-iron"></span>
  üü° –ó–æ–ª–æ—Ç—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-gold"></span>
  üíé –ê–ª–º–∞–∑—ã<span id="ingot-diamond"></span>
  </div>

  <div class="furnace-core"></div>

  <div class="box">
    <div>üî• –û–ø—ã—Ç: <span id="smeltXp"></span></div>
    <div>üéØ –®–∞–Ω—Å: <span id="smeltChance"></span></div>
  </div>

  <button onclick="smelt('copper')">–ú–µ–¥—å</button><br><br>
  <button onclick="smelt('iron')">–ñ–µ–ª–µ–∑–æ</button><br><br>
  <button onclick="smelt('gold')">–ó–æ–ª–æ—Ç–æ</button><br><br>
  <button onclick="smelt('diamond')">–ê–ª–º–∞–∑</button>

  <div id="smeltResult"></div>
</div>

<!-- ===== EQUIP ===== -->
<div id="tab-equip" class="tab">
  <div class="box">
    <h3>–ö—Ä–∞—Ñ—Ç –∫–∏—Ä–æ–∫</h3>
    <div id="craft-pickaxes"></div>
  </div>

  <div class="box">
    <h3>–ú–æ–∏ –∫–∏—Ä–∫–∏</h3>
    <div id="my-pickaxes"></div>
  </div>
</div>

<!-- ===== WITHDRAW ===== -->
<div id="tab-withdraw" class="tab">
  <div class="box">
    <h3>üí∞ –í—ã–≤–æ–¥</h3>
    <p class="label">–°–µ–∑–æ–Ω –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω</p>
    <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–≥—Ä–∞–¥–∞—Ö –∏ –≤—ã–≤–æ–¥–µ</p>
  </div>
      <div class="box">
  üü§ –ú–µ–¥–Ω—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-copper2"></span>
  ‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-iron2"></span>
  üü° –ó–æ–ª–æ—Ç—ã–µ —Å–ª–∏—Ç–∫–∏<span id="ingot-gold2"></span>
  üíé –ê–ª–º–∞–∑—ã<span id="ingot-diamond2"></span>
      </div>
</div>

</div>

<!-- ===== NAV ===== -->
<div class="nav">
  <div class="nav-btn active" onclick="showTab('mine')"><div>‚õèÔ∏è</div>–®–∞—Ö—Ç–∞</div>
  <div class="nav-btn" onclick="showTab('furnace')"><div>üî•</div>–ü–µ—á—å</div>
  <div class="nav-btn" onclick="showTab('equip')"><div>‚öíÔ∏è</div>–≠–∫–∏–ø</div>
  <div class="nav-btn" onclick="showTab('withdraw')"><div>üí∞</div>–í—ã–≤–æ–¥</div>
</div>
  
<script>
  /*
const tg = window.Telegram.WebApp;
tg.ready();

const API_URL = "https://oremine-worker.orange123893-383.workers.dev";
let currentUserId = null;

const BLOCK_NAMES = {
  stone: "–ö–∞–º–µ–Ω—å",
  coal: "–£–≥–æ–ª—å–Ω—ã–π –±–ª–æ–∫",
  copper: "–ú–µ–¥–Ω—ã–π –±–ª–æ–∫",
  iron: "–ñ–µ–ª–µ–∑–Ω—ã–π –±–ª–æ–∫",
  gold: "–ó–æ–ª–æ—Ç–æ–π –±–ª–æ–∫",
  diamond: "–ê–ª–º–∞–∑–Ω—ã–π –±–ª–æ–∫"
};

const PICKAXE_CRAFTS = [
  {
    type: "copper",
    name: "–ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞",
    cost: 25,
    chance: 0.8
  },
  {
    type: "iron",
    name: "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞",
    cost: 25,
    chance: 0.6
  },
  {
    type: "gold",
    name: "–ó–æ–ª–æ—Ç–∞—è –∫–∏—Ä–∫–∞",
    cost: 25,
    chance: 0.4
  },
  {
    type: "diamond",
    name: "–ê–ª–º–∞–∑–Ω–∞—è –∫–∏—Ä–∫–∞",
    cost: 25,
    chance: 0.2
  }
];

function showTab(tab) {
  document.getElementById("tab-mine").style.display =
    tab === "mine" ? "block" : "none";

  document.getElementById("tab-equip").style.display =
    tab === "equip" ? "block" : "none";

  document.getElementById("tab-furnace").style.display =
    tab === "furnace" ? "block" : "none";

  document.getElementById("tab-withdraw").style.display =
    tab === "withdraw" ? "block" : "none";
}

async function loadPlayer() {
  if (!tg.initDataUnsafe?.user?.id) {
    document.getElementById("status").innerText =
      "–û—à–∏–±–∫–∞: Telegram user.id –Ω–µ –Ω–∞–π–¥–µ–Ω";
    return;
  }

  currentUserId = tg.initDataUnsafe.user.id;

  const res = await fetch(`${API_URL}/getUser?user_id=${currentUserId}`);
  const player = await res.json();
  renderPlayer(player);
}

async function craftPickaxe(type) {
  const res = await fetch(`${API_URL}/craftPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: currentUserId,
      type
    })
  });

  const data = await res.json();

  if (data.error) {
    alert("–ö—Ä–∞—Ñ—Ç –Ω–µ —É–¥–∞–ª—Å—è");
    return;
  }

  alert(data.success ? "–ö–∏—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!" : "–ù–µ—É–¥–∞—á–∞ üò¢");
  loadPlayer();
}

async function equipPickaxe(id) {
  await fetch(`${API_URL}/equipPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: currentUserId,
      pickaxeId: id
    })
  });

  loadPlayer();
}

async function smelt(type) {
  try {
    const res = await fetch(
      `${API_URL}/smelt?user_id=${currentUserId}&ore=${type}`
    );

    const data = await res.json();

    if (data.error) {
      if (data.error === "NO_ORE") alert("–ù–µ—Ç —Ä—É–¥—ã");
      if (data.error === "NO_COAL") alert("–ù—É–∂–Ω–æ 2 —É–≥–ª—è");
      return;
    }

    if (data.result === "success") {
      document.getElementById("smeltResult").innerText =
        "‚úÖ –ü–æ–ª—É—á–µ–Ω —Å–ª–∏—Ç–æ–∫!";
    } else {
      document.getElementById("smeltResult").innerText =
        "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–ø–ª–∞–≤–∏—Ç—å";
    }

    loadPlayer();

  } catch {
    alert("–û—à–∏–±–∫–∞ –ø–µ—á–∏");
  }
}

function renderPlayer(player) {
  document.getElementById("status").style.display = "none";
  document.getElementById("player").style.display = "block";

  document.getElementById("uid").innerText = player.id;
  document.getElementById("energy").innerText =
    `${player.energy} / ${player.maxEnergy}`;
  document.getElementById("depth").innerText = player.depth;

  document.getElementById("ore-coal").innerText = player.ores.coal;
  document.getElementById("ore-copper").innerText = player.ores.copper_ore;
  document.getElementById("ore-iron").innerText = player.ores.iron_ore;
  document.getElementById("ore-gold").innerText = player.ores.gold_ore;
  document.getElementById("ore-diamond").innerText = player.ores.diamond_ore;

  document.getElementById("blockType").innerText =
    BLOCK_NAMES[player.currentBlock.type] || player.currentBlock.type;

  document.getElementById("blockHp").innerText =
    `${player.currentBlock.hp} / ${player.currentBlock.maxHp}`;

  renderCraft(player);
  renderPickaxes(player);

  document.getElementById("smeltXp").innerText =
  player.smeltXp || 0;

const chance = Math.min(
  0.5 + ((player.smeltXp || 0) / 1000) * 0.3,
  0.8
);

document.getElementById("smeltChance").innerText =
  Math.floor(chance * 100) + "%";
}

function renderCraft(player) {
  const box = document.getElementById("craft-pickaxes");
  box.innerHTML = "";

  PICKAXE_CRAFTS.forEach(craft => {
    const ingots = player.ingots[craft.type] || 0;
    const canCraft = ingots >= craft.cost;

    const div = document.createElement("div");
    div.className = "box";

    div.innerHTML = `
      <b>${craft.name}</b><br>
      –ù—É–∂–Ω–æ: ${craft.cost} —Å–ª–∏—Ç–∫–æ–≤<br>
      –®–∞–Ω—Å: ${Math.floor(craft.chance * 100)}%<br>
      –£ –≤–∞—Å: ${ingots}<br>
      <button ${!canCraft ? "disabled" : ""}
        onclick="craftPickaxe('${craft.type}')">
        –ö—Ä–∞—Ñ—Ç
      </button>
    `;

    box.appendChild(div);
  });
}

function renderPickaxes(player) {
  const box = document.getElementById("my-pickaxes");
  box.innerHTML = "";

  if (!player.pickaxes || player.pickaxes.length === 0) {
    box.innerText = "–ö–∏—Ä–æ–∫ –Ω–µ—Ç";
    return;
  }

  player.pickaxes.forEach(p => {
    const equipped = player.equippedPickaxeId === p.id;

    const div = document.createElement("div");
    div.className = "box";

    div.innerHTML = `
      <b>${p.type.toUpperCase()} –∫–∏—Ä–∫–∞</b><br>
      ‚õèÔ∏è –°–∏–ª–∞: +${p.stats.power}<br>
      ‚ö° –≠–Ω–µ—Ä–≥–∏—è: +${p.stats.energy || 0}<br>
      <button onclick="equipPickaxe('${p.id}')">
        ${equipped ? "–°–Ω—è—Ç—å" : "–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å"}
      </button>
    `;

    box.appendChild(div);
  });
}

document.getElementById("mineBtn").onclick = async () => {
  const res = await fetch(`${API_URL}/mine?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "NO_ENERGY") {
    alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏");
    return;
  }

  renderPlayer(data.user);

  const rewardEl = document.getElementById("reward");
rewardEl.innerText = "";

// —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±–ª–æ–∫ –±—ã–ª —Å–ª–æ–º–∞–Ω
if (data.reward) {
  const rewardNames = {
    coal: "–£–≥–æ–ª—å",
    copper_ore: "–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞",
    iron_ore: "–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞",
    gold_ore: "–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞",
    diamond_ore: "–ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞"
  };

  rewardEl.innerText =
    `–ü–æ–ª—É—á–µ–Ω–æ: ${rewardNames[data.reward]} √ó1`;
}
  
};

loadPlayer();
*/
const tg = window.Telegram.WebApp;
tg.ready();

const API_URL = "https://oremine-worker.orange123893-383.workers.dev";
let currentUserId = null;

const BLOCK_NAMES = {
  stone: "–ö–∞–º–µ–Ω—å",
  coal: "–£–≥–æ–ª—å–Ω—ã–π –±–ª–æ–∫",
  copper: "–ú–µ–¥–Ω—ã–π –±–ª–æ–∫",
  iron: "–ñ–µ–ª–µ–∑–Ω—ã–π –±–ª–æ–∫",
  gold: "–ó–æ–ª–æ—Ç–æ–π –±–ª–æ–∫",
  diamond: "–ê–ª–º–∞–∑–Ω—ã–π –±–ª–æ–∫"
};

const PICKAXE_CRAFTS = [
  { type: "copper", name: "–ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.8 },
  { type: "iron", name: "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.6 },
  { type: "gold", name: "–ó–æ–ª–æ—Ç–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.4 },
  { type: "diamond", name: "–ê–ª–º–∞–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.2 }
];

/* ================== NAV ================== */
function showTab(tab) {
  ["mine", "furnace", "equip", "withdraw"].forEach(t => {
    document.getElementById(`tab-${t}`).style.display =
      t === tab ? "block" : "none";
  });

  document.querySelectorAll(".nav-btn").forEach(btn =>
    btn.classList.remove("active")
  );

  document
    .querySelector(`.nav-btn[onclick="showTab('${tab}')"]`)
    .classList.add("active");

  const titles = {
    mine: "–®–∞—Ö—Ç–∞",
    furnace: "–ü–µ—á—å",
    equip: "–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞",
    withdraw: "–í—ã–≤–æ–¥"
  };

  document.getElementById("tabTitle").innerText = titles[tab];
}

/* ================== LOAD PLAYER ================== */
async function loadPlayer() {
  if (!tg.initDataUnsafe?.user?.id) {
    document.getElementById("status").innerText =
      "–û—à–∏–±–∫–∞ Telegram ID";
    return;
  }

  currentUserId = tg.initDataUnsafe.user.id;

  const res = await fetch(`${API_URL}/getUser?user_id=${currentUserId}`);
  const player = await res.json();
  renderPlayer(player);

  // üî• –í–ê–ñ–ù–û: —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à–∞—Ö—Ç—É
  showTab("mine");
}

/* ================== MINE ================== */
document.getElementById("mineBtn").onclick = async () => {
  const res = await fetch(`${API_URL}/mine?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "NO_ENERGY") {
    alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏");
    return;
  }

  renderPlayer(data.user);

  const rewardEl = document.getElementById("reward");
  rewardEl.innerText = "";

  if (data.reward) {
    const names = {
      coal: "–£–≥–æ–ª—å",
      copper_ore: "–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞",
      iron_ore: "–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞",
      gold_ore: "–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞",
      diamond_ore: "–ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞"
    };
    rewardEl.innerText = `–ü–æ–ª—É—á–µ–Ω–æ: ${names[data.reward]} √ó1`;
  }
};

/* ================== FURNACE ================== */
async function smelt(type) {
  const res = await fetch(
    `${API_URL}/smelt?user_id=${currentUserId}&ore=${type}`
  );

  const data = await res.json();
  const out = document.getElementById("smeltResult");

  if (data.error) {
    out.innerText =
      data.error === "NO_ORE"
        ? "–ù–µ—Ç —Ä—É–¥—ã"
        : "–ù—É–∂–Ω–æ 2 —É–≥–ª—è";
    return;
  }

  out.innerText =
    data.result === "success"
      ? "‚úÖ –ü–æ–ª—É—á–µ–Ω —Å–ª–∏—Ç–æ–∫"
      : "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å";

  loadPlayer();
}

/* ================== EQUIP ================== */
async function craftPickaxe(type) {
  const res = await fetch(`${API_URL}/craftPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, type })
  });

  const data = await res.json();
  alert(data.success ? "–ö–∏—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!" : "–ù–µ—É–¥–∞—á–∞ üò¢");
  loadPlayer();
}

async function equipPickaxe(id) {
  await fetch(`${API_URL}/equipPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, pickaxeId: id })
  });
  loadPlayer();
}

/* ================== RENDER ================== */
function renderPlayer(player) {
  document.getElementById("status").style.display = "none";
  document.getElementById("player").style.display = "block";

  document.getElementById("energy").innerText =
    `${player.energy} / ${player.maxEnergy}`;
  document.getElementById("depth").innerText = player.depth;

  // –†—É–¥–∞
  document.getElementById("ore-coal").innerText = player.ores.coal;
  document.getElementById("ore-copper").innerText = player.ores.copper_ore;
  document.getElementById("ore-iron").innerText = player.ores.iron_ore;
  document.getElementById("ore-gold").innerText = player.ores.gold_ore;
  document.getElementById("ore-diamond").innerText = player.ores.diamond_ore;

  // –°–ª–∏—Ç–∫–∏ (–ø–µ—á—å)
  document.getElementById("ingot-copper").innerText = player.ingots.copper;
  document.getElementById("ingot-iron").innerText = player.ingots.iron;
  document.getElementById("ingot-gold").innerText = player.ingots.gold;
  document.getElementById("ingot-diamond").innerText = player.ingots.diamond;

  // –°–ª–∏—Ç–∫–∏ (–≤—ã–≤–æ–¥)
  document.getElementById("ingot-copper2").innerText = player.ingots.copper;
  document.getElementById("ingot-iron2").innerText = player.ingots.iron;
  document.getElementById("ingot-gold2").innerText = player.ingots.gold;
  document.getElementById("ingot-diamond2").innerText = player.ingots.diamond;
  
  // –ë–ª–æ–∫
  document.getElementById("blockType").innerText =
    BLOCK_NAMES[player.currentBlock.type];

  document.getElementById("blockHp").innerText =
    `${player.currentBlock.hp} / ${player.currentBlock.maxHp}`;

  document.getElementById("hpFill").style.width =
    (player.currentBlock.hp / player.currentBlock.maxHp) * 100 + "%";

  // –ü–µ—á—å
  document.getElementById("smeltXp").innerText = player.smeltXp || 0;

  const chance = Math.min(
    0.5 + ((player.smeltXp || 0) / 1000) * 0.3,
    0.8
  );
  document.getElementById("smeltChance").innerText =
    Math.floor(chance * 100) + "%";

  renderCraft(player);
  renderPickaxes(player);
}

function renderCraft(player) {
  const box = document.getElementById("craft-pickaxes");
  box.innerHTML = "";

  PICKAXE_CRAFTS.forEach(c => {
    const have = player.ingots[c.type] || 0;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${c.name}</b><br>
      –ù—É–∂–Ω–æ: ${c.cost}<br>
      –®–∞–Ω—Å: ${Math.floor(c.chance * 100)}%<br>
      –£ –≤–∞—Å: ${have}<br>
      <button ${have < c.cost ? "disabled" : ""} onclick="craftPickaxe('${c.type}')">
        –ö—Ä–∞—Ñ—Ç
      </button>
    `;
    box.appendChild(div);
  });
}

function renderPickaxes(player) {
  const box = document.getElementById("my-pickaxes");
  box.innerHTML = "";

  if (!player.pickaxes?.length) {
    box.innerText = "–ö–∏—Ä–æ–∫ –Ω–µ—Ç";
    return;
  }

  player.pickaxes.forEach(p => {
    const eq = player.equippedPickaxeId === p.id;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${p.type.toUpperCase()} –∫–∏—Ä–∫–∞</b><br>
      ‚õèÔ∏è +${p.stats.power}<br>
      ‚ö° +${p.stats.energy || 0}<br>
      <button onclick="equipPickaxe('${p.id}')">
        ${eq ? "–°–Ω—è—Ç—å" : "–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å"}
      </button>
    `;
    box.appendChild(div);
  });
}

loadPlayer();

</script>

</body>
</html>
