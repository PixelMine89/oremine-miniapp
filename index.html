<!DOCTYPE html>
<html lang="ru">
<head> 
  <meta charset="UTF-8" />
  <title>OreMine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    :root {
  --bg: #0b0e13;
  --panel: #141824;
  --panel-soft: #1b2032;
  --accent: #f5c77a;
  --muted: #9aa0b4;
  --danger: #ff6b6b;
  --success: #4cd964;
}

/* ===== DISABLE SELECTION ===== */

html, body, * {
  -webkit-user-select: none; /* iOS */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-touch-callout: none; /* —É–±–∏—Ä–∞–µ—Ç –º–µ–Ω—é –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ iOS */
  -webkit-tap-highlight-color: transparent;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg);
  color: white;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 100px 0 120px 0;
}

/* ===== TOP PANEL ===== */

.top-wrapper {
  position: fixed;
  top: 16px;
  left: 16px;
  right: 16px;
  z-index: 1000;
}

.top-panel {
  background: linear-gradient(180deg, #303030, #252525);
  border-radius: 22px;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
  border: 2px solid rgba(255,255,255,0.15);
}

.top-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 2px solid var(--accent);
}

.player-info {
  display: flex;
  flex-direction: column;
}

.player-name {
  font-weight: 700;
  font-size: 14px;
}

.player-id {
  font-size: 11px;
  color: var(--muted);
}

/* ===== COMMON ===== */
.box {
  background: linear-gradient(180deg, var(--panel), var(--panel-soft));
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.label {
  font-size: 12px;
  color: var(--muted);
}

button {
  background: linear-gradient(180deg, #f5c77a, #d6a956);
  border: none;
  border-radius: 14px;
  padding: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.05s ease, filter 0.05s ease;
}

button:active {
  transform: scale(0.96);
  filter: brightness(0.85);
}

button:disabled {
  opacity: 0.4;
}

/* ===== TABS ===== */
.tab {
  display: none;
  padding: 16px;
}

/* ===== MINE ===== */
.mine-shaft {
  height: 240px;
  background: linear-gradient(180deg, #0c1020, #070a14);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

.block {
  width: 140px;
  height: 140px;
  border-radius: 16px;
  background: #444;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.hunt-block {
  width: 70px;
  height: 70px;
  border-radius: 10px;
  font-size: 10px;
}

.hp-bar {
  width: 100%;
  height: 8px;
  background: #222;
  border-radius: 4px;
  margin-top: 8px;
  overflow: hidden;
}

.hp-fill {
  height: 100%;
  background: var(--success);
}

.mineBtn {
  width: 100%;
}

/* ===== FURNACE ===== */

.furnace-core {
  height: 200px;
  border-radius: 16px;
  background: radial-gradient(circle, #ffae42, #5a2a00);
  margin-bottom: 12px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;          
}

.furnace-core-button {
  height: 80px;
  width: calc(50% - 20px);
  margin: 10px;
}

/* ===== EQUIP ===== */
.item {
  background: #1a1f33;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 8px;
}

/* ===== NEW BOTTOM NAV ===== */

.nav-wrapper {
  position: fixed;
  bottom: 16px;
  left: 16px;
  right: 16px;
  z-index: 1000;
}

.nav {
  background: linear-gradient(180deg, #303030, #252525);
  border-radius: 22px;
  padding: 4px 4px;
  display: flex;
  justify-content: space-between;
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
  border: 2px solid rgba(255,255,255,0.3);
}

.nav-btn {
  flex: 1;
  text-align: center;
  font-size: 11px;
  color: #7f869c;
  cursor: pointer;
  transition: 0.2s ease;
  padding: 6px 0;
  border-radius: 14px;
}

.nav-btn img {
  width: 22px;
  height: 22px;
  margin-bottom: 4px;
  opacity: 0.6;
  transition: 0.2s ease;
}

.nav-btn.active {
  background: rgba(245,199,122,0.08);
  color: var(--accent);
}

.nav-btn.active img {
  opacity: 1;
  transform: translateY(-2px);
}

.nav-btn:active {
  transform: scale(0.95);
}

  /* ===== MINING LOADER ===== */

#loader {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, #1e1e1e, #111);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loader-box {
  text-align: center;
}

.rock {
  width: 120px;
  height: 120px;
  background: linear-gradient(145deg, #3a3a3a, #1f1f1f);
  border-radius: 16px;
  margin: auto;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
  animation: crack 1.2s infinite;
}

.pickaxe {
  font-size: 40px;
  margin-top: -90px;
  animation: swing 1.2s infinite;
}

.loading-text {
  margin-top: 40px;
  font-size: 14px;
  color: #aaa;
  letter-spacing: 1px;
}

@keyframes swing {
  0% { transform: rotate(-40deg); }
  50% { transform: rotate(20deg); }
  100% { transform: rotate(-40deg); }
}

@keyframes crack {
  0%,100% { transform: scale(1); }
  50% { transform: scale(0.96); }
}

    /* ===== MINE INFO BUTTON ===== */

.mine-stats {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mine-stats-left {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.info-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: rgba(245,199,122,0.15);
  border: 2px solid var(--accent);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.1s ease, background 0.1s ease;
}

.info-btn:active {
  transform: scale(0.9);
  background: rgba(245,199,122,0.3);
}
  </style>
</head>
<body>

<div id="loader">
  <div class="loader-box">
    <div class="rock"></div>
    <div class="pickaxe">‚õèÔ∏è</div>
    <div id="status" class="loading-text">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  </div>
</div>

<div id="player" style="display:none">
  <!-- ===== TOP PANEL ===== -->
  <div class="top-wrapper">
    <div class="top-panel">
      <div class="top-left">
        <img src="https://i.pravatar.cc/100" class="avatar" id="playerAvatar">
        <div class="player-info">
          <div class="player-name" id="playerName">–ò–≥—Ä–æ–∫</div>
          <div class="player-id" id="playerId">ID: 0</div>
        </div>
      </div>
      <div id="ton-connect"></div>
    </div>
  </div>
  <!-- ===== MINE ===== -->
  <div id="tab-mine" class="tab">
    <div class="mine-shaft">
      <div class="block" id="blockVisual">
        <div id="blockType"></div>
        <div class="hp-bar">
          <div class="hp-fill" id="hpFill"></div>
        </div>
        <div id="blockHp"></div>
      </div>
    </div>
    <div class="box mine-stats">
      <div class="mine-stats-left">
        <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy"></span></div>
        <div>‚¨áÔ∏è –ì–ª—É–±–∏–Ω–∞: <span id="depth"></span></div>
      </div>
      <div class="info-btn" onclick="openMineInfo()">i</div>
    </div>
    <div style="text-align: center;">
      <button class="mineBtn" id="mineBtn">‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>
    </div>
    <div id="reward" style="margin-top:10px;"></div>
    <div style="margin-top:12px; text-align:center;">
      <button id="huntBtn" onclick="onHuntButton()">üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin</button>
    </div>
  </div>
  <!-- ===== HUNT ===== -->
  <div id="tab-hunt" class="tab">
    <div class="box">
      <div>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: <span id="hunt-timer">--:--</span></div>
      <div>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="hunt-earned">0</span> $DigCoin</div>
      <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="hunt-energy"></span></div>
    </div>
    <div class="box">
      <div id="hunt-grid" style="
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      "></div>
    </div>
    <button id="hunt-mine-btn" disabled>‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>
  </div>
  <!-- ===== CRAFT (–ü–µ—á—å + –≠–∫–∏–ø) ===== -->
<div id="tab-craft" class="tab">

  <div class="box">
    <h3>ü™® –í–∞—à–∞ —Ä—É–¥–∞</h3>
    <div>ü™® –£–≥–æ–ª—å: <span id="ore-coal"></span></div>
    <div>üü§ –ú–µ–¥–Ω–∞—è —Ä—É–¥–∞: <span id="ore-copper"></span></div>
    <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-iron"></span></div>
    <div>üü° –ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞: <span id="ore-gold"></span></div>
    <div>üíé –ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-diamond"></span></div>
  </div>

  <div class="box">
    <h3>üî• –ü–ª–∞–≤–∫–∞</h3>

    <div>üü§ –ú–µ–¥–Ω—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-copper"></span></div>
    <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-iron"></span></div>
    <div>üü° –ó–æ–ª–æ—Ç—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-gold"></span></div>
    <div>üíé –ê–ª–º–∞–∑—ã: <span id="ingot-diamond"></span></div>

    <div class="furnace-core">
      <button class="furnace-core-button" onclick="smelt('copper')">
        –ú–µ–¥–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br>(1 –º–µ–¥–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
      </button>
      <button class="furnace-core-button" onclick="smelt('iron')">
        –ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br>(1 –∂–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
      </button>
      <button class="furnace-core-button" onclick="smelt('gold')">
        –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫<br>(1 –∑–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
      </button>
      <button class="furnace-core-button" onclick="smelt('diamond')">
        –ê–ª–º–∞–∑<br>(1 –∞–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)
      </button>
    </div>

    <div id="smeltResult"></div>

    <div class="box">
      <div>üî• –û–ø—ã—Ç: <span id="smeltXp"></span></div>
      <div>üéØ –®–∞–Ω—Å: <span id="smeltChance"></span></div>
    </div>
  </div>

  <div class="box">
    <h3>‚õèÔ∏è –ö—Ä–∞—Ñ—Ç –∫–∏—Ä–æ–∫</h3>
    <div id="craft-pickaxes"></div>
  </div>

  <div class="box">
    <h3>üéí –ú–æ–∏ –∫–∏—Ä–∫–∏</h3>
    <div id="my-pickaxes"></div>
  </div>

</div>


<!-- ===== MARKET ===== -->
<div id="tab-market" class="tab">
  <div class="box">
    <h3>üè™ –†—ã–Ω–æ–∫</h3>
    <p class="label">
      –ó–¥–µ—Å—å –∏–≥—Ä–æ–∫–∏ —Å–º–æ–≥—É—Ç –ø–æ–∫—É–ø–∞—Ç—å –∏ –ø—Ä–æ–¥–∞–≤–∞—Ç—å:
      —Ä–µ—Å—É—Ä—Å—ã, —Å–ª–∏—Ç–∫–∏, –∫–∏—Ä–∫–∏ –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã.
    </p>
  </div>

  <div class="box">
    <h4>üì¶ –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h4>
    <button>–°–æ–∑–¥–∞—Ç—å –ª–æ—Ç</button>
  </div>

  <div class="box">
    <h4>üõí –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h4>
    <div id="market-list">
      –°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è —Ä—ã–Ω–æ–∫...
    </div>
  </div>
</div>


<!-- ===== EXCHANGE (–°–í–ê–ü) ===== -->
<div id="tab-exchange" class="tab">
  <div class="box">
    <h3>üîÑ –û–±–º–µ–Ω DigCoin ‚Üî TON</h3>
    <p class="label">
      –ö–æ–º–∏—Å—Å–∏—è: 5% –∑–∞ –∫–∞–∂–¥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
    </p>
  </div>

  <div class="box">
    <div>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å:</div>
    <div>$DigCoin: <span id="dig-coin"></span></div>
  </div>

  <div class="box">
    <h4>–ö—É–ø–∏—Ç—å DigCoin</h4>
    <input type="number" placeholder="TON" style="width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:10px;">
    <button>–ö—É–ø–∏—Ç—å</button>
  </div>

  <div class="box">
    <h4>–ü—Ä–æ–¥–∞—Ç—å DigCoin</h4>
    <input type="number" placeholder="DigCoin" style="width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:10px;">
    <button>–ü—Ä–æ–¥–∞—Ç—å</button>
  </div>
</div>
  <!-- ===== TASKS ===== -->
  <div id="tab-tasks" class="tab">
    <div class="box" style="text-align:center;">
      <h3>üìú –ó–∞–¥–∞–Ω–∏—è</h3>
    </div>
    <!-- TELEGRAM TASK -->
    <div class="box" id="channelTaskBox">
      <b>üì¢ –í—Å—Ç—É–ø–∏—Ç—å –≤ Telegram –∫–∞–Ω–∞–ª</b>
      <p class="label">
        –í—Å—Ç—É–ø–∏—Ç–µ –≤ –Ω–∞—à –∫–∞–Ω–∞–ª –∏ –ø–æ–ª—É—á–∏—Ç–µ 50 DigCoin
      </p>

      <div id="channelTaskActions">
        <button onclick="joinChannel()">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª</button>
        <button id="checkChannelBtn" onclick="checkChannelTask()">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        </button>
      </div>

      <div id="channelTaskDone" style="
        display:none;
        margin-top:10px;
        padding:10px;
        background: rgba(0,255,150,0.1);
        border:1px solid rgba(0,255,150,0.3);
        border-radius:8px;
        color:#00ff95;
        font-weight:bold;
        text-align:center;
      ">
        ‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!
      </div>
    </div>
    <!-- REFERRAL TASK -->
    <div class="box">
      <b>üë• –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</b>
      <p class="label">
        –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞–Ω–∏–µ
        "–í—Å—Ç—É–ø–∏—Ç—å –≤ Telegram –∫–∞–Ω–∞–ª" ‚Äî 100 DigCoin
      </p>
      <div style="font-size:12px; margin:8px 0;">
        –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:
        <div id="refLink" style="
          word-break: break-all;
          font-size:11px;
          color: var(--accent);
          margin-top:4px;">
        </div>
      </div>
      <button onclick="copyRef()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <div style="margin-top:12px;">
        <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è:</b>
        <div id="refFriends" style="
          max-height:120px;
          overflow-y:auto;
          font-size:12px;
          margin-top:6px;
          color: var(--muted);
        ">
        </div>
      </div>
    </div>
  </div>
  <div id="huntResultModal" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  ">
    <div class="box" style="max-width:300px; text-align:center;">
      <h3>üéØ –û—Ö–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
      <div style="margin:12px 0;">
        –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:<br>
        <b><span id="huntResultEarned">0</span> $DigCoin</b>
      </div>
      <button onclick="closeHuntResult()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div id="huntCooldownModal" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  ">
    <div class="box" style="max-width:300px; text-align:center;">
      <h3>‚è≥ –û—Ö–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
      <div style="margin:12px 0;">
        –°–ª–µ–¥—É—é—â–∞—è –æ—Ö–æ—Ç–∞ —á–µ—Ä–µ–∑:<br>
        <b><span id="huntCooldownTime">--:--</span></b>
      </div>
      <button onclick="closeHuntCooldown()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div id="mineInfoModal" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  ">
    <div class="box" style="
      max-width: 340px;
      width: 90%;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
    ">
      <h3 style="text-align:center;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      <div style="
        overflow-y: auto;
        font-size: 12px;
        color: var(--muted);
        margin: 12px 0;
        line-height: 1.5;
      ">
        <strong>–≠–Ω–µ—Ä–≥–∏—è</strong> - –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º –∫–æ–ø–∞—Ç—å
        –±–ª–æ–∫–∏ –≤ —à–∞—Ö—Ç–µ, –∞ —Ç–∞–∫ –∂–µ –Ω–∞ –æ—Ö–æ—Ç–µ. –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π
        –∞–≤—Ç–æ–∫–æ–ø–∫–µ –≤ —Ç–µ—á–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±—É–¥–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤–∞—Ç—å—Å—è 
        –≤—Å—è —ç–Ω–µ—Ä–≥–∏—è –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥. <br><br>
        <strong>–ì–ª—É–±–∏–Ω–∞</strong> - –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        –≤—ã–∫–æ–ø–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤. –ß–µ–º –±–æ–ª—å—à–µ –≥–ª—É–±–∏–Ω–∞ - —Ç–µ–º –±–æ–ª—å—à–µ
        —à–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è —Ü–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ x2<br><br>
        <strong>–û—Ö–æ—Ç–∞ –∑–∞ $DigCoin</strong> - —Ä–µ–∂–∏–º –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –º–æ–∂–µ—Ç–µ
        –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å DigCoin. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–∏—Ö –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤
        —Ä–∞–∑–¥–µ–ª–µ –≤—ã–≤–æ–¥ –≤ –º–µ–Ω—é —Å–Ω–∏–∑—É.<br>
        –û—Ö–æ—Ç–∞ –¥–ª–∏—Ç—Å—è 10 –º–∏–Ω—É—Ç, –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 24 —á–∞—Å–∞. –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –æ—Ö–æ—Ç—ã,
        –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –¥–µ–≤—è—Ç–∏ –±–ª–æ–∫–æ–≤, –ø–æ—Å–ª–µ —á–µ–≥–æ
        –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±—ã–≤–∞—Ç—å –µ–≥–æ. –ë–ª–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ—Ç 30—Å–µ–∫ –¥–æ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ 
        –ø–æ—è–≤–ª–µ–Ω–∏—è, –ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π. –ï—Å–ª–∏ –≤—ã —É—Å–ø–µ–ª–∏ –≤—ã–∫–æ–ø–∞—Ç—å
        –±–ª–æ–∫ - –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DigCoin –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ 
        —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –ü–æ—Å–ª–µ —á–µ–≥–æ –±–ª–æ–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—Å—è.<br>
      </div>
      <button onclick="closeMineInfo()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <!-- ===== NAV ===== -->
  <div class="nav-wrapper">
    <div class="nav">
      <div class="nav-btn active" onclick="showTab('mine')">
        <img src="icon-home.png">
        <div>–®–∞—Ö—Ç–∞</div>
      </div>

      <div class="nav-btn" onclick="showTab('craft')">
        <img src="icon-equip.png">
        <div>–ö—Ä–∞—Ñ—Ç</div>
      </div>

      <div class="nav-btn" onclick="showTab('market')">
        <img src="icon-market.png">
        <div>–†—ã–Ω–æ–∫</div>
      </div>

      <div class="nav-btn" onclick="showTab('tasks')">
        <img src="icon-tasks.png">
        <div>–ó–∞–¥–∞–Ω–∏—è</div>
      </div>

      <div class="nav-btn" onclick="showTab('exchange')">
        <img src="icon-exchange.png">
        <div>–û–±–º–µ–Ω</div>
      </div>
    </div>
  </div>
</div>
  
<script>
const tg = window.Telegram.WebApp;
tg.ready();

const API_URL = "https://digrise.ru";

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://digrise-miniapp.vercel.app/manifest.json",
  buttonRootId: "ton-connect"
});
  
let currentUserId = null;
let startParam = null;

let huntSelectedIndex = null;
let huntTimerInterval = null;
let huntStateInterval = null;
let currentHuntActive = false;
let huntMineInProgress = false;

let playerInterval = null;

const BLOCK_NAMES = {
  stone: "–ö–∞–º–µ–Ω—å",
  coal: "–£–≥–æ–ª—å–Ω—ã–π –±–ª–æ–∫",
  copper: "–ú–µ–¥–Ω—ã–π –±–ª–æ–∫",
  iron: "–ñ–µ–ª–µ–∑–Ω—ã–π –±–ª–æ–∫",
  gold: "–ó–æ–ª–æ—Ç–æ–π –±–ª–æ–∫",
  diamond: "–ê–ª–º–∞–∑–Ω—ã–π –±–ª–æ–∫"
};

const PICKAXE_CRAFTS = [
  { type: "copper", name: "–ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.8 },
  { type: "iron", name: "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.6 },
  { type: "gold", name: "–ó–æ–ª–æ—Ç–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.4 },
  { type: "diamond", name: "–ê–ª–º–∞–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.2 }
];

const BLOCK_COLORS = {
  stone: "#555",
  coal: "#222",
  copper: "#b87333",
  iron: "#aaa",
  gold: "#f5c77a",
  diamond: "#4fdcff"
};

/* ================== NAV ================== */
function showTab(tab) {
  if (tab !== "hunt" && huntStateInterval) {
  clearInterval(huntStateInterval);
  huntStateInterval = null;
  }
  
  ["mine", "craft", "market", "exchange", "hunt", "tasks"].forEach(t => {
    document.getElementById(`tab-${t}`).style.display =
      t === tab ? "block" : "none";
  });

  document.querySelectorAll(".nav-btn").forEach(btn =>
    btn.classList.remove("active")
  );

  const navBtn = document.querySelector(
  `.nav-btn[onclick="showTab('${tab}')"]`
);

if (navBtn) {
  navBtn.classList.add("active");
}

if (tab === "tasks") {
  loadTasks();
}

}

/* ================== LOAD PLAYER ================== */
async function loadPlayer() {
  if (!tg.initDataUnsafe?.user?.id) {
    document.getElementById("status").innerText =
      "–û—à–∏–±–∫–∞ Telegram ID";
    return;
  }
  
  currentUserId = tg.initDataUnsafe.user.id;

  const res = await fetch(
    `${API_URL}/getUser?user_id=${currentUserId}`
  );
  const player = await res.json();
  
  renderPlayer(player);
  checkHuntOnLoad();

  playerInterval = setInterval(loadPlayerDataOnly, 500);

  // üî• –í–ê–ñ–ù–û: —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à–∞—Ö—Ç—É
  showTab("mine");
}

async function loadPlayerDataOnly() {
  const res = await fetch(
    `${API_URL}/getUser?user_id=${currentUserId}`
  );
  const player = await res.json();
  renderPlayer(player);
}

/* ================== MINE ================== */
document.getElementById("mineBtn").onclick = async () => {
  const res = await fetch(`${API_URL}/mine?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "NO_ENERGY") {
    alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏");
    return;
  }

  renderPlayer(data.user);

  const rewardEl = document.getElementById("reward");
  rewardEl.innerText = "";

  if (data.reward) {
    const names = {
      coal: "–£–≥–æ–ª—å",
      copper_ore: "–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞",
      iron_ore: "–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞",
      gold_ore: "–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞",
      diamond_ore: "–ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞"
    };
    rewardEl.innerText = `–ü–æ–ª—É—á–µ–Ω–æ: ${names[data.reward]} √ó1`;
  }
};

/* ================== FURNACE ================== */
async function smelt(type) {
  const res = await fetch(
    `${API_URL}/smelt?user_id=${currentUserId}&ore=${type}`
  );

  const data = await res.json();
  const out = document.getElementById("smeltResult");

  if (data.error) {
    out.innerText =
      data.error === "NO_ORE"
        ? "–ù–µ—Ç —Ä—É–¥—ã"
        : "–ù—É–∂–Ω–æ 2 —É–≥–ª—è";
    return;
  }

  out.innerText =
    data.result === "success"
      ? "‚úÖ –ü–æ–ª—É—á–µ–Ω —Å–ª–∏—Ç–æ–∫"
      : "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å";

  loadPlayer();
}

/* ================== EQUIP ================== */
async function craftPickaxe(type) {
  const res = await fetch(`${API_URL}/craftPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, type })
  });

  const data = await res.json();
  alert(data.success ? "–ö–∏—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!" : "–ù–µ—É–¥–∞—á–∞ üò¢");
  loadPlayer();
}

async function equipPickaxe(id) {
  await fetch(`${API_URL}/equipPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, pickaxeId: id })
  });
  loadPlayer();
}

async function startHunt() {
  const res = await fetch(`${API_URL}/hunt/start?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "HUNT_COOLDOWN") {
    showHuntCooldown(data.nextAvailableAt);
    return;
  }

  if (data.error) {
    return;
  }

  showTab("hunt");
  loadHuntState();
}

function onHuntButton() {
  if (currentHuntActive) {
    showTab("hunt");
    loadHuntState();
  } else {
    startHunt();
  }
}

async function loadHuntState() {
  const res = await fetch(`${API_URL}/hunt/state?user_id=${currentUserId}`);
  const data = await res.json();

  currentHuntActive = data.active;

const huntBtn = document.getElementById("huntBtn");
if (huntBtn) {
  huntBtn.innerText = data.active
    ? "üéØ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ö–æ—Ç—É"
    : "üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin";
}

if (!data.active) {
  if (data.finished) {
    showHuntResult(data.earned);
    return;
  }

  if (data.nextAvailableAt && data.nextAvailableAt > Date.now()) {
    showHuntCooldown(data.nextAvailableAt);
    return;
  }

  return;
}

if (!data.blocks || !Array.isArray(data.blocks)) {
  console.warn("Hunt blocks not ready yet");
  return;
}

renderHunt(data);

  if (!huntStateInterval) {
    huntStateInterval = setInterval(loadHuntState, 1000);
  }
}

async function checkHuntOnLoad() {
  const res = await fetch(
    `${API_URL}/hunt/state?user_id=${currentUserId}`
  );
  const data = await res.json();

  currentHuntActive = data.active;

  const huntBtn = document.getElementById("huntBtn");
  if (huntBtn) {
    huntBtn.innerText = data.active
      ? "üéØ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ö–æ—Ç—É"
      : "üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin";
  }

  // ‚úÖ –í–ê–ñ–ù–û: –µ—Å–ª–∏ –æ—Ö–æ—Ç–∞ –ó–ê–ö–û–ù–ß–ò–õ–ê–°–¨ –ø–æ–∫–∞ –∏–≥—Ä–æ–∫–∞ –Ω–µ –±—ã–ª–æ
  if (!data.active && data.finished) {
    showHuntResult(data.earned);
  }
}

document.getElementById("hunt-mine-btn").onclick = async () => {
  if (huntSelectedIndex === null) return;

  const res = await fetch(
    `${API_URL}/hunt/mine?user_id=${currentUserId}&index=${huntSelectedIndex}`
  );

  const data = await res.json();

  if (data.error === "NO_ENERGY") {
    alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏");
    return;
  }

  if (data.success) {
    await loadHuntState();
  }
};

function showHuntResult(earned) {
  document.getElementById("huntResultEarned").innerText = earned;
  document.getElementById("huntResultModal").style.display = "flex";
}

function closeHuntResult() {
  document.getElementById("huntResultModal").style.display = "none";
  showTab("mine");
  loadPlayer();
}

let huntCooldownInterval = null;

function showHuntCooldown(nextAvailableAt) {
  const modal = document.getElementById("huntCooldownModal");
  const timeEl = document.getElementById("huntCooldownTime");

  modal.style.display = "flex";

  function tick() {
    const left = nextAvailableAt - Date.now();

    if (left <= 0) {
      clearInterval(huntCooldownInterval);
      modal.style.display = "none";
      loadPlayer();
      return;
    }

    const hours = Math.floor(left / 3600000);
    const minutes = Math.floor((left % 3600000) / 60000);

    timeEl.innerText = `${hours}—á ${minutes}–º`;
  }

  tick();
  huntCooldownInterval = setInterval(tick, 1000);
}

function closeHuntCooldown() {
  if (huntCooldownInterval) {
    clearInterval(huntCooldownInterval);
    huntCooldownInterval = null;
  }
  document.getElementById("huntCooldownModal").style.display = "none";
}

function openMineInfo() {
  document.getElementById("mineInfoModal").style.display = "flex";
}

function closeMineInfo() {
  document.getElementById("mineInfoModal").style.display = "none";
}

/* ================= TASKS ================= */

async function loadTasks() {
  const res = await fetch(`${API_URL}/tasks?user_id=${currentUserId}`);
  const data = await res.json();

  document.getElementById("refLink").innerText = data.refLink;

  // üëâ –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
  renderChannelTask(data.channelTaskDone);

  const friendsBox = document.getElementById("refFriends");
  friendsBox.innerHTML = "";

  if (!data.friends.length) {
    friendsBox.innerText = "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç";
    return;
  }

  data.friends.forEach(f => {
    const div = document.createElement("div");
    div.innerText = "‚Ä¢ " + f;
    friendsBox.appendChild(div);
  });
}

function joinChannel() {
  window.open("https://t.me/digrise_channel", "_blank");
}

async function checkChannelTask() {
  const res = await fetch(`${API_URL}/tasks/checkChannel`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ user_id: currentUserId })
  });

  const data = await res.json();

  if (data.success) {
    renderChannelTask(true); // üî• –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º UI
    loadPlayer();
  } else {
    alert("–í—ã –µ—â—ë –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å üò¢");
  }
}

function copyRef() {
  const text = document.getElementById("refLink").innerText;
  navigator.clipboard.writeText(text);
  alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
}

/* ================== RENDER ================== */
function renderPlayer(player) {
  document.getElementById("loader").style.display = "none";
  document.getElementById("player").style.display = "block";

  // –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
document.getElementById("playerName").innerText =
  tg.initDataUnsafe?.user?.username || "–ò–≥—Ä–æ–∫";

document.getElementById("playerId").innerText =
  "ID: " + currentUserId;

if (tg.initDataUnsafe?.user?.photo_url) {
  document.getElementById("playerAvatar").src =
    tg.initDataUnsafe.user.photo_url;
}

  document.getElementById("energy").innerText =
    `${player.energy} / ${player.maxEnergy}`;
  document.getElementById("depth").innerText = player.depth;

  // –†—É–¥–∞
  document.getElementById("ore-coal").innerText = player.ores.coal;
  document.getElementById("ore-copper").innerText = player.ores.copper_ore;
  document.getElementById("ore-iron").innerText = player.ores.iron_ore;
  document.getElementById("ore-gold").innerText = player.ores.gold_ore;
  document.getElementById("ore-diamond").innerText = player.ores.diamond_ore;

  // –°–ª–∏—Ç–∫–∏ (–ø–µ—á—å)
  document.getElementById("ingot-copper").innerText = player.ingots.copper;
  document.getElementById("ingot-iron").innerText = player.ingots.iron;
  document.getElementById("ingot-gold").innerText = player.ingots.gold;
  document.getElementById("ingot-diamond").innerText = player.ingots.diamond;

  // DigCoin (–≤—ã–≤–æ–¥)
  document.getElementById("dig-coin").innerText =
  player.digCoin;
  
  // –ë–ª–æ–∫
  document.getElementById("blockType").innerText =
    BLOCK_NAMES[player.currentBlock.type];

  document.getElementById("blockVisual").style.background =
  BLOCK_COLORS[player.currentBlock.type] || "#444";

  document.getElementById("blockHp").innerText =
    `${player.currentBlock.hp} / ${player.currentBlock.maxHp}`;

  document.getElementById("hpFill").style.width =
    (player.currentBlock.hp / player.currentBlock.maxHp) * 100 + "%";

  // –ü–µ—á—å
  document.getElementById("smeltXp").innerText = player.smeltXp || 0;

  const chance = Math.min(
    0.5 + ((player.smeltXp || 0) / 1000) * 0.3,
    0.8
  );
  document.getElementById("smeltChance").innerText =
    Math.floor(chance * 100) + "%";

  renderCraft(player);
  renderPickaxes(player);
}

function renderCraft(player) {
  const box = document.getElementById("craft-pickaxes");
  box.innerHTML = "";

  PICKAXE_CRAFTS.forEach(c => {
    const have = player.ingots[c.type] || 0;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
  <b>${c.name}</b><br>
  –ù—É–∂–Ω–æ: ${c.cost}<br>
  –®–∞–Ω—Å: ${Math.floor(c.chance * 100)}%<br>
  –£ –≤–∞—Å: ${have}<br>

  <button ${have < c.cost ? "disabled" : ""} onclick="craftPickaxe('${c.type}')">
    –ö—Ä–∞—Ñ—Ç
  </button>

  <button onclick="buyPickaxeTON('${c.type}')">
    –ö—É–ø–∏—Ç—å –∑–∞ ${{
      copper: "0.5",
      iron: "2",
      gold: "7",
      diamond: "20"
    }[c.type]} TON
  </button>
`;
    box.appendChild(div);
  });
}

function renderPickaxes(player) {
  const box = document.getElementById("my-pickaxes");
  box.innerHTML = "";

  if (!player.pickaxes?.length) {
    box.innerText = "–ö–∏—Ä–æ–∫ –Ω–µ—Ç";
    return;
  }

  player.pickaxes.forEach(p => {
    const eq = player.equippedPickaxeId === p.id;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${p.type.toUpperCase()} –∫–∏—Ä–∫–∞</b><br>
      ‚õèÔ∏è –°–∏–ª–∞: +${p.stats.power}<br>
      ‚ö° –ö—Ä–∏—Ç: +${p.stats.critChance}<br>
      <button onclick="equipPickaxe('${p.id}')">
        ${eq ? "–°–Ω—è—Ç—å" : "–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å"}
      </button>
    `;
    box.appendChild(div);
  });
}

function renderHunt(hunt) {
  document.getElementById("hunt-earned").innerText = hunt.earned;
  document.getElementById("hunt-energy").innerText =
  `${hunt.energy} / ${hunt.maxEnergy}`;

  renderHuntTimer(hunt.endsAt);
  renderHuntBlocks(hunt.blocks);
}

function renderHuntTimer(endsAt) {
  endsAt = Number(endsAt);
  
  if (huntTimerInterval) clearInterval(huntTimerInterval);

  function tick() {
    const left = endsAt - Date.now();

    if (left <= 0) {
      clearInterval(huntTimerInterval);
      clearInterval(huntStateInterval);
      huntStateInterval = null;
      showTab("mine");
      loadPlayer();
      return;
    }

    const min = Math.floor(left / 60000);
    const sec = Math.floor((left % 60000) / 1000);
    document.getElementById("hunt-timer").innerText =
      `${String(min).padStart(2, "0")}:${String(sec).padStart(2, "0")}`;
  }

  tick();
  huntTimerInterval = setInterval(tick, 1000);
}

function renderHuntBlocks(blocks) {
  const grid = document.getElementById("hunt-grid");
  grid.innerHTML = "";

  blocks.forEach((b, i) => {
    const div = document.createElement("div");
    div.className = "block hunt-block";
    div.style.background =
  BLOCK_COLORS[b.type] || "#444";
    div.style.cursor = "pointer";
    div.innerHTML = `
      <div>${BLOCK_NAMES[b.type]}</div>
      <div class="hp-bar">
        <div class="hp-fill" style="width:${(b.hp / b.maxHp) * 100}%"></div>
      </div>
      <div>${b.hp} / ${b.maxHp}</div>
    `;

    div.onclick = () => {
      huntSelectedIndex = i;
      document.getElementById("hunt-mine-btn").disabled = false;

      document.querySelectorAll("#hunt-grid .block").forEach(el =>
        el.style.outline = "none"
      );
      div.style.outline = "2px solid var(--accent)";
    };

    grid.appendChild(div);

    if (huntSelectedIndex !== null && i === huntSelectedIndex) {
  div.style.outline = "2px solid var(--accent)";
    }
  });
}

function renderChannelTask(isDone) {
  const actions = document.getElementById("channelTaskActions");
  const doneBlock = document.getElementById("channelTaskDone");

  if (isDone) {
    actions.style.display = "none";
    doneBlock.style.display = "block";
  } else {
    actions.style.display = "block";
    doneBlock.style.display = "none";
  }
}

async function buyPickaxeTON(type) {

  if (!tonConnectUI.connected) {
    await tonConnectUI.connectWallet();
  }
  
  const pricesNano = {
    copper: "500000000",
    iron: "2000000000",
    gold: "7000000000",
    diamond: "20000000000"
  };

  const payload = {
    user_id: currentUserId,
    type
  };

  const transaction = {
    validUntil: Math.floor(Date.now() / 1000) + 600,
    messages: [
      {
        address: "UQBkxJxTtskm_Co7jlIw7LMOkCNSC33KNo2EuqIlDrXiuhNn",
        amount: pricesNano[type]
      }
    ]
  };

  try {
    const result = await tonConnectUI.sendTransaction(transaction);
    alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    await fetch(`${API_URL}/ton/verify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        txHash: result.transactionHash,
        user_id: currentUserId,
        type
      })
    });

    alert("–ü–æ–∫—É–ø–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!");
    loadPlayer();

  } catch (e) {
  alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!");
  }
}

loadPlayer();

</script>

</body>
</html>
