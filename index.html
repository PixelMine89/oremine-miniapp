<!DOCTYPE html>
<html lang="ru">
<head> 
  <meta charset="UTF-8" />
  <title>OreMine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    :root {
  --bg: #0b0e13;
  --panel: #141824;
  --panel-soft: #1b2032;
  --accent: #f5c77a;
  --muted: #9aa0b4;
  --danger: #ff6b6b;
  --success: #4cd964;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg);
  color: white;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  padding-bottom: 100px;
}

/* ===== HEADER ===== */
.header {
  text-align: center;
  padding: 16px;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* ===== COMMON ===== */
.box {
  background: linear-gradient(180deg, var(--panel), var(--panel-soft));
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.label {
  font-size: 12px;
  color: var(--muted);
}

button {
  background: linear-gradient(180deg, #f5c77a, #d6a956);
  border: none;
  border-radius: 14px;
  padding: 12px;
  font-weight: 700;
  cursor: pointer;
}

button:disabled {
  opacity: 0.4;
}

/* ===== TABS ===== */
.tab {
  display: none;
  padding: 16px;
}

/* ===== MINE ===== */
.mine-shaft {
  height: 240px;
  background: linear-gradient(180deg, #0c1020, #070a14);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

.block {
  width: 140px;
  height: 140px;
  border-radius: 16px;
  background: #444;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.hunt-block {
  width: 70px;
  height: 70px;
  border-radius: 10px;
  font-size: 10px;
}

.hp-bar {
  width: 100%;
  height: 8px;
  background: #222;
  border-radius: 4px;
  margin-top: 8px;
  overflow: hidden;
}

.hp-fill {
  height: 100%;
  background: var(--success);
}

.mineBtn {
  width: 100%;
}

/* ===== FURNACE ===== */

.furnace-core {
  height: 200px;
  border-radius: 16px;
  background: radial-gradient(circle, #ffae42, #5a2a00);
  margin-bottom: 12px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;          
}

.furnace-core-button {
  height: 80px;
  width: calc(50% - 20px);
  margin: 10px;
}

/* ===== EQUIP ===== */
.item {
  background: #1a1f33;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 8px;
}

/* ===== NEW BOTTOM NAV ===== */

.nav-wrapper {
  position: fixed;
  bottom: 16px;
  left: 16px;
  right: 16px;
  z-index: 1000;
}

.nav {
  background: linear-gradient(180deg, #303030, #252525);
  border-radius: 22px;
  padding: 10px 6px;
  display: flex;
  justify-content: space-between;
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
  border: 2px solid rgba(255,255,255,0.3);
}

.nav-btn {
  flex: 1;
  text-align: center;
  font-size: 11px;
  color: #7f869c;
  cursor: pointer;
  transition: 0.2s ease;
  padding: 6px 0;
  border-radius: 14px;
}

.nav-btn img {
  width: 22px;
  height: 22px;
  margin-bottom: 4px;
  opacity: 0.6;
  transition: 0.2s ease;
}

.nav-btn.active {
  background: rgba(245,199,122,0.08);
  color: var(--accent);
}

.nav-btn.active img {
  opacity: 1;
  transform: translateY(-2px);
}

.nav-btn:active {
  transform: scale(0.95);
}
  </style>
</head>
<body>
<div class="header" id="tabTitle">–®–∞—Ö—Ç–∞</div>
  
<div id="ton-connect"></div>
  
<div id="status" class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="player" style="display:none">

<!-- ===== MINE ===== -->
<div id="tab-mine" class="tab">
  <div class="mine-shaft">
    <div class="block" id="blockVisual">
      <div id="blockType"></div>
      <div class="hp-bar">
        <div class="hp-fill" id="hpFill"></div>
      </div>
      <div id="blockHp"></div>
    </div>
  </div>

  <div class="box">
    <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy"></span></div>
    <div>‚¨áÔ∏è –ì–ª—É–±–∏–Ω–∞: <span id="depth"></span></div>
  </div>

  <div style="text-align: center;">
  <button class="mineBtn" id="mineBtn">‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>
  </div>
  <div id="reward" style="margin-top:10px;"></div>
  <div style="margin-top:12px; text-align:center;">
    <button id="huntBtn" onclick="onHuntButton()">üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin</button>
  </div>
</div>

<!-- ===== HUNT ===== -->
<div id="tab-hunt" class="tab">

  <div class="box">
    <div>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: <span id="hunt-timer">--:--</span></div>
    <div>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="hunt-earned">0</span> $DigCoin</div>
    <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="hunt-energy"></span></div>
  </div>

  <div class="box">
    <div id="hunt-grid" style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    "></div>
  </div>

  <button id="hunt-mine-btn" disabled>‚õèÔ∏è –ö–æ–ø–∞—Ç—å</button>

</div>

<!-- ===== FURNACE ===== -->
<div id="tab-furnace" class="tab">
  <div class="box">
    <div>ü™® –£–≥–æ–ª—å: <span id="ore-coal"></span></div>
    <div>üü§ –ú–µ–¥–Ω–∞—è —Ä—É–¥–∞: <span id="ore-copper"></span></div>
    <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-iron"></span></div>
    <div>üü° –ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞: <span id="ore-gold"></span></div>
    <div>üíé –ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞: <span id="ore-diamond"></span></div>
  </div>

  <div class="box">
  <div>üü§ –ú–µ–¥–Ω—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-copper"></span></div>
  <div>‚öôÔ∏è –ñ–µ–ª–µ–∑–Ω—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-iron"></span></div>
  <div>üü° –ó–æ–ª–æ—Ç—ã–µ —Å–ª–∏—Ç–∫–∏: <span id="ingot-gold"></span></div>
  <div>üíé –ê–ª–º–∞–∑—ã: <span id="ingot-diamond"></span></div>
  </div>

  <div class="furnace-core">
    <button class="furnace-core-button" onclick="smelt('copper')">
      –ú–µ–¥–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br>(1 –º–µ–¥–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)</button>
    <button class="furnace-core-button" onclick="smelt('iron')">
      –ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫<br>(1 –∂–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)</button>
    <button class="furnace-core-button" onclick="smelt('gold')">
      –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫<br>(1 –∑–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)</button>
    <button class="furnace-core-button" onclick="smelt('diamond')">
      –ê–ª–º–∞–∑<br>(1 –∞–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞, 2 —É–≥–ª—è)</button>
  </div>

  <div id="smeltResult"></div>
  
  <div class="box">
    <div>üî• –û–ø—ã—Ç: <span id="smeltXp"></span></div>
    <div>üéØ –®–∞–Ω—Å: <span id="smeltChance"></span></div>
  </div>
</div>

<!-- ===== EQUIP ===== -->
<div id="tab-equip" class="tab">
  <div class="box">
    <h3>–ö—Ä–∞—Ñ—Ç –∫–∏—Ä–æ–∫</h3>
    <div id="craft-pickaxes"></div>
  </div>

  <div class="box">
    <h3>–ú–æ–∏ –∫–∏—Ä–∫–∏</h3>
    <div id="my-pickaxes"></div>
  </div>
</div>

<!-- ===== WITHDRAW ===== -->
<div id="tab-withdraw" class="tab">
  <div class="box">
    <h3>üí∞ –í—ã–≤–æ–¥</h3>
    <p class="label">–°–µ–∑–æ–Ω –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω 30.03.2026</p>
    <p>–í –∫–æ–Ω—Ü–µ —Å–µ–∑–æ–Ω–∞ —Å 30.03.2026 –ø–æ 01.04.2026 –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω—è—Ç—å $DigCoin
    –Ω–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –∑–≤—ë–∑–¥—ã.<br>–ö—É—Ä—Å –æ–±–º–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ: 50% —Å—É–º–º—ã 
    –≤—Å–µ—Ö –¥–æ–Ω–∞—Ç–æ–≤ / –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö $DigCoin.<br>–í—ã–≤–æ–¥ –±—É–¥–µ—Ç 
    –≤–æ–∑–º–æ–∂–µ–Ω –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –≤ 50 –∑–≤—ë–∑–¥.</p>
  </div>
      <div class="box">
  <div>$DigCoin: <span id="dig-coin"></span></div>
      </div>
</div>

</div>

<div id="huntResultModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
">
  <div class="box" style="max-width:300px; text-align:center;">
    <h3>üéØ –û—Ö–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
    <div style="margin:12px 0;">
      –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:<br>
      <b><span id="huntResultEarned">0</span> $DigCoin</b>
    </div>
    <button onclick="closeHuntResult()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="huntCooldownModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
">
  <div class="box" style="max-width:300px; text-align:center;">
    <h3>‚è≥ –û—Ö–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
    <div style="margin:12px 0;">
      –°–ª–µ–¥—É—é—â–∞—è –æ—Ö–æ—Ç–∞ —á–µ—Ä–µ–∑:<br>
      <b><span id="huntCooldownTime">--:--</span></b>
    </div>
    <button onclick="closeHuntCooldown()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- ===== NAV ===== -->
<div class="nav-wrapper">
  <div class="nav">

    <div class="nav-btn active" onclick="showTab('mine')">
      <img src="icon-home.png">
      <div>–®–∞—Ö—Ç–∞</div>
    </div>

    <div class="nav-btn" onclick="showTab('furnace')">
      <img src="icon-furnace.png">
      <div>–ü–µ—á—å</div>
    </div>

    <div class="nav-btn" onclick="showTab('equip')">
      <img src="icon-equip.png">
      <div>–≠–∫–∏–ø</div>
    </div>

    <div class="nav-btn" onclick="showTab('withdraw')">
      <img src="icon-withdraw.png">
      <div>–í—ã–≤–æ–¥</div>
    </div>

  </div>
</div>
  
<script>
const tg = window.Telegram.WebApp;
tg.ready();

const API_URL = "https://digrise.ru";

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://digrise-miniapp.vercel.app/manifest.json",
  buttonRootId: "ton-connect"
});
  
let currentUserId = null;

let huntSelectedIndex = null;
let huntTimerInterval = null;
let huntStateInterval = null;
let currentHuntActive = false;
let huntMineInProgress = false;

let playerInterval = null;

const BLOCK_NAMES = {
  stone: "–ö–∞–º–µ–Ω—å",
  coal: "–£–≥–æ–ª—å–Ω—ã–π –±–ª–æ–∫",
  copper: "–ú–µ–¥–Ω—ã–π –±–ª–æ–∫",
  iron: "–ñ–µ–ª–µ–∑–Ω—ã–π –±–ª–æ–∫",
  gold: "–ó–æ–ª–æ—Ç–æ–π –±–ª–æ–∫",
  diamond: "–ê–ª–º–∞–∑–Ω—ã–π –±–ª–æ–∫"
};

const PICKAXE_CRAFTS = [
  { type: "copper", name: "–ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.8 },
  { type: "iron", name: "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.6 },
  { type: "gold", name: "–ó–æ–ª–æ—Ç–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.4 },
  { type: "diamond", name: "–ê–ª–º–∞–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost: 25, chance: 0.2 }
];

const BLOCK_COLORS = {
  stone: "#555",
  coal: "#222",
  copper: "#b87333",
  iron: "#aaa",
  gold: "#f5c77a",
  diamond: "#4fdcff"
};

/* ================== NAV ================== */
function showTab(tab) {
  if (tab !== "hunt" && huntStateInterval) {
  clearInterval(huntStateInterval);
  huntStateInterval = null;
  }
  
  ["mine", "furnace", "equip", "withdraw", "hunt"].forEach(t => {
    document.getElementById(`tab-${t}`).style.display =
      t === tab ? "block" : "none";
  });

  document.querySelectorAll(".nav-btn").forEach(btn =>
    btn.classList.remove("active")
  );

  const navBtn = document.querySelector(
  `.nav-btn[onclick="showTab('${tab}')"]`
);

if (navBtn) {
  navBtn.classList.add("active");
}

  const titles = {
    mine: "–®–∞—Ö—Ç–∞",
    furnace: "–ü–µ—á—å",
    equip: "–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞",
    withdraw: "–í—ã–≤–æ–¥",
    hunt: "–û—Ö–æ—Ç–∞ –∑–∞ $DigCoin"
  };

  document.getElementById("tabTitle").innerText = titles[tab];
}

/* ================== LOAD PLAYER ================== */
async function loadPlayer() {
  if (!tg.initDataUnsafe?.user?.id) {
    document.getElementById("status").innerText =
      "–û—à–∏–±–∫–∞ Telegram ID";
    return;
  }
  
  currentUserId = tg.initDataUnsafe.user.id;
  
  const res = await fetch(`${API_URL}/getUser?user_id=${currentUserId}`);
  const player = await res.json();
  
  renderPlayer(player);
  checkHuntOnLoad();

  playerInterval = setInterval(loadPlayerDataOnly, 1000);

  // üî• –í–ê–ñ–ù–û: —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à–∞—Ö—Ç—É
  showTab("mine");
}

async function loadPlayerDataOnly() {
  const res = await fetch(`${API_URL}/getUser?user_id=${currentUserId}`);
  const player = await res.json();
  renderPlayer(player);
}

/* ================== MINE ================== */
document.getElementById("mineBtn").onclick = async () => {
  const res = await fetch(`${API_URL}/mine?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "NO_ENERGY") {
    alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏");
    return;
  }

  renderPlayer(data.user);

  const rewardEl = document.getElementById("reward");
  rewardEl.innerText = "";

  if (data.reward) {
    const names = {
      coal: "–£–≥–æ–ª—å",
      copper_ore: "–ú–µ–¥–Ω–∞—è —Ä—É–¥–∞",
      iron_ore: "–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞",
      gold_ore: "–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞",
      diamond_ore: "–ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞"
    };
    rewardEl.innerText = `–ü–æ–ª—É—á–µ–Ω–æ: ${names[data.reward]} √ó1`;
  }
};

/* ================== FURNACE ================== */
async function smelt(type) {
  const res = await fetch(
    `${API_URL}/smelt?user_id=${currentUserId}&ore=${type}`
  );

  const data = await res.json();
  const out = document.getElementById("smeltResult");

  if (data.error) {
    out.innerText =
      data.error === "NO_ORE"
        ? "–ù–µ—Ç —Ä—É–¥—ã"
        : "–ù—É–∂–Ω–æ 2 —É–≥–ª—è";
    return;
  }

  out.innerText =
    data.result === "success"
      ? "‚úÖ –ü–æ–ª—É—á–µ–Ω —Å–ª–∏—Ç–æ–∫"
      : "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å";

  loadPlayer();
}

/* ================== EQUIP ================== */
async function craftPickaxe(type) {
  const res = await fetch(`${API_URL}/craftPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, type })
  });

  const data = await res.json();
  alert(data.success ? "–ö–∏—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!" : "–ù–µ—É–¥–∞—á–∞ üò¢");
  loadPlayer();
}

async function equipPickaxe(id) {
  await fetch(`${API_URL}/equipPickaxe`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: currentUserId, pickaxeId: id })
  });
  loadPlayer();
}

async function startHunt() {
  const res = await fetch(`${API_URL}/hunt/start?user_id=${currentUserId}`);
  const data = await res.json();

  if (data.error === "HUNT_COOLDOWN") {
    showHuntCooldown(data.nextAvailableAt);
    return;
  }

  if (data.error) {
    return;
  }

  showTab("hunt");
  loadHuntState();
}

function onHuntButton() {
  if (currentHuntActive) {
    showTab("hunt");
    loadHuntState();
  } else {
    startHunt();
  }
}

async function loadHuntState() {
  const res = await fetch(`${API_URL}/hunt/state?user_id=${currentUserId}`);
  const data = await res.json();

  currentHuntActive = data.active;

const huntBtn = document.getElementById("huntBtn");
if (huntBtn) {
  huntBtn.innerText = data.active
    ? "üéØ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ö–æ—Ç—É"
    : "üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin";
}

if (!data.active) {
  if (data.finished) {
    showHuntResult(data.earned);
    return;
  }

  if (data.nextAvailableAt && data.nextAvailableAt > Date.now()) {
    showHuntCooldown(data.nextAvailableAt);
    return;
  }

  return;
}

if (!data.blocks || !Array.isArray(data.blocks)) {
  console.warn("Hunt blocks not ready yet");
  return;
}

renderHunt(data);

  if (!huntStateInterval) {
    huntStateInterval = setInterval(loadHuntState, 1000);
  }
}

async function checkHuntOnLoad() {
  const res = await fetch(
    `${API_URL}/hunt/state?user_id=${currentUserId}`
  );
  const data = await res.json();

  currentHuntActive = data.active;

  const huntBtn = document.getElementById("huntBtn");
  if (huntBtn) {
    huntBtn.innerText = data.active
      ? "üéØ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ö–æ—Ç—É"
      : "üéØ –û—Ö–æ—Ç–∞ –∑–∞ $DigCoin";
  }

  // ‚úÖ –í–ê–ñ–ù–û: –µ—Å–ª–∏ –æ—Ö–æ—Ç–∞ –ó–ê–ö–û–ù–ß–ò–õ–ê–°–¨ –ø–æ–∫–∞ –∏–≥—Ä–æ–∫–∞ –Ω–µ –±—ã–ª–æ
  if (!data.active && data.finished) {
    showHuntResult(data.earned);
  }
}

document.getElementById("hunt-mine-btn").onclick = async () => {
  if (huntSelectedIndex === null) return;
  if (huntMineInProgress) return;

  huntMineInProgress = true;
  document.getElementById("hunt-mine-btn").disabled = true;

  try {
    const res = await fetch(
      `${API_URL}/hunt/mine?user_id=${currentUserId}&index=${huntSelectedIndex}`
    );
    const data = await res.json();

    if (data.success) {
      await loadHuntState();
    }
  } finally {
    huntMineInProgress = false;
    document.getElementById("hunt-mine-btn").disabled = false;
  }
};

function showHuntResult(earned) {
  document.getElementById("huntResultEarned").innerText = earned;
  document.getElementById("huntResultModal").style.display = "flex";
}

function closeHuntResult() {
  document.getElementById("huntResultModal").style.display = "none";
  showTab("mine");
  loadPlayer();
}

let huntCooldownInterval = null;

function showHuntCooldown(nextAvailableAt) {
  const modal = document.getElementById("huntCooldownModal");
  const timeEl = document.getElementById("huntCooldownTime");

  modal.style.display = "flex";

  function tick() {
    const left = nextAvailableAt - Date.now();

    if (left <= 0) {
      clearInterval(huntCooldownInterval);
      modal.style.display = "none";
      loadPlayer();
      return;
    }

    const hours = Math.floor(left / 3600000);
    const minutes = Math.floor((left % 3600000) / 60000);

    timeEl.innerText = `${hours}—á ${minutes}–º`;
  }

  tick();
  huntCooldownInterval = setInterval(tick, 1000);
}

function closeHuntCooldown() {
  if (huntCooldownInterval) {
    clearInterval(huntCooldownInterval);
    huntCooldownInterval = null;
  }
  document.getElementById("huntCooldownModal").style.display = "none";
}

/* ================== RENDER ================== */
function renderPlayer(player) {
  document.getElementById("status").style.display = "none";
  document.getElementById("player").style.display = "block";

  document.getElementById("energy").innerText =
    `${player.energy} / ${player.maxEnergy}`;
  document.getElementById("depth").innerText = player.depth;

  // –†—É–¥–∞
  document.getElementById("ore-coal").innerText = player.ores.coal;
  document.getElementById("ore-copper").innerText = player.ores.copper_ore;
  document.getElementById("ore-iron").innerText = player.ores.iron_ore;
  document.getElementById("ore-gold").innerText = player.ores.gold_ore;
  document.getElementById("ore-diamond").innerText = player.ores.diamond_ore;

  // –°–ª–∏—Ç–∫–∏ (–ø–µ—á—å)
  document.getElementById("ingot-copper").innerText = player.ingots.copper;
  document.getElementById("ingot-iron").innerText = player.ingots.iron;
  document.getElementById("ingot-gold").innerText = player.ingots.gold;
  document.getElementById("ingot-diamond").innerText = player.ingots.diamond;

  // DigCoin (–≤—ã–≤–æ–¥)
  document.getElementById("dig-coin").innerText =
  player.digCoin;
  
  // –ë–ª–æ–∫
  document.getElementById("blockType").innerText =
    BLOCK_NAMES[player.currentBlock.type];

  document.getElementById("blockVisual").style.background =
  BLOCK_COLORS[player.currentBlock.type] || "#444";

  document.getElementById("blockHp").innerText =
    `${player.currentBlock.hp} / ${player.currentBlock.maxHp}`;

  document.getElementById("hpFill").style.width =
    (player.currentBlock.hp / player.currentBlock.maxHp) * 100 + "%";

  // –ü–µ—á—å
  document.getElementById("smeltXp").innerText = player.smeltXp || 0;

  const chance = Math.min(
    0.5 + ((player.smeltXp || 0) / 1000) * 0.3,
    0.8
  );
  document.getElementById("smeltChance").innerText =
    Math.floor(chance * 100) + "%";

  renderCraft(player);
  renderPickaxes(player);
}

function renderCraft(player) {
  const box = document.getElementById("craft-pickaxes");
  box.innerHTML = "";

  PICKAXE_CRAFTS.forEach(c => {
    const have = player.ingots[c.type] || 0;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
  <b>${c.name}</b><br>
  –ù—É–∂–Ω–æ: ${c.cost}<br>
  –®–∞–Ω—Å: ${Math.floor(c.chance * 100)}%<br>
  –£ –≤–∞—Å: ${have}<br>

  <button ${have < c.cost ? "disabled" : ""} onclick="craftPickaxe('${c.type}')">
    –ö—Ä–∞—Ñ—Ç
  </button>

  <button onclick="buyPickaxeTON('${c.type}')">
    –ö—É–ø–∏—Ç—å –∑–∞ ${{
      copper: "0.5",
      iron: "2",
      gold: "7",
      diamond: "20"
    }[c.type]} TON
  </button>
`;
    box.appendChild(div);
  });
}

function renderPickaxes(player) {
  const box = document.getElementById("my-pickaxes");
  box.innerHTML = "";

  if (!player.pickaxes?.length) {
    box.innerText = "–ö–∏—Ä–æ–∫ –Ω–µ—Ç";
    return;
  }

  player.pickaxes.forEach(p => {
    const eq = player.equippedPickaxeId === p.id;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${p.type.toUpperCase()} –∫–∏—Ä–∫–∞</b><br>
      ‚õèÔ∏è –°–∏–ª–∞: +${p.stats.power}<br>
      ‚ö° –ö—Ä–∏—Ç: +${p.stats.critChance}<br>
      <button onclick="equipPickaxe('${p.id}')">
        ${eq ? "–°–Ω—è—Ç—å" : "–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å"}
      </button>
    `;
    box.appendChild(div);
  });
}

function renderHunt(hunt) {
  document.getElementById("hunt-earned").innerText = hunt.earned;
  document.getElementById("hunt-energy").innerText =
  `${hunt.energy} / ${hunt.maxEnergy}`;

  renderHuntTimer(hunt.endsAt);
  renderHuntBlocks(hunt.blocks);
}

function renderHuntTimer(endsAt) {
  endsAt = Number(endsAt);
  
  if (huntTimerInterval) clearInterval(huntTimerInterval);

  function tick() {
    const left = endsAt - Date.now();

    if (left <= 0) {
      clearInterval(huntTimerInterval);
      clearInterval(huntStateInterval);
      huntStateInterval = null;
      showTab("mine");
      loadPlayer();
      return;
    }

    const min = Math.floor(left / 60000);
    const sec = Math.floor((left % 60000) / 1000);
    document.getElementById("hunt-timer").innerText =
      `${String(min).padStart(2, "0")}:${String(sec).padStart(2, "0")}`;
  }

  tick();
  huntTimerInterval = setInterval(tick, 1000);
}

function renderHuntBlocks(blocks) {
  const grid = document.getElementById("hunt-grid");
  grid.innerHTML = "";

  blocks.forEach((b, i) => {
    const div = document.createElement("div");
    div.className = "block hunt-block";
    div.style.background =
  BLOCK_COLORS[b.type] || "#444";
    div.style.cursor = "pointer";
    div.innerHTML = `
      <div>${BLOCK_NAMES[b.type]}</div>
      <div class="hp-bar">
        <div class="hp-fill" style="width:${(b.hp / b.maxHp) * 100}%"></div>
      </div>
      <div>${b.hp} / ${b.maxHp}</div>
    `;

    div.onclick = () => {
      huntSelectedIndex = i;
      document.getElementById("hunt-mine-btn").disabled = false;

      document.querySelectorAll("#hunt-grid .block").forEach(el =>
        el.style.outline = "none"
      );
      div.style.outline = "2px solid var(--accent)";
    };

    grid.appendChild(div);

    if (huntSelectedIndex !== null && i === huntSelectedIndex) {
  div.style.outline = "2px solid var(--accent)";
    }
  });
}

async function buyPickaxeTON(type) {

  if (!tonConnectUI.connected) {
    await tonConnectUI.connectWallet();
  }
  
  const pricesNano = {
    copper: "500000000",
    iron: "2000000000",
    gold: "7000000000",
    diamond: "20000000000"
  };

  const payload = {
    user_id: currentUserId,
    type
  };

  const transaction = {
    validUntil: Math.floor(Date.now() / 1000) + 600,
    messages: [
      {
        address: "UQBkxJxTtskm_Co7jlIw7LMOkCNSC33KNo2EuqIlDrXiuhNn",
        amount: pricesNano[type]
      }
    ]
  };

  try {
    const result = await tonConnectUI.sendTransaction(transaction);
    alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    await fetch(`${API_URL}/ton/verify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        txHash: result.transactionHash,
        user_id: currentUserId,
        type
      })
    });

    alert("–ü–æ–∫—É–ø–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!");
    loadPlayer();

  } catch (e) {
  alert("–û—à–∏–±–∫–∞: " + JSON.stringify(e));
  }
}

loadPlayer();

</script>

</body>
</html>
